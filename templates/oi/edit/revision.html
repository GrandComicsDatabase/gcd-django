{% extends "oi/base_view.html" %}

{% load static %}

{% load credits %}
{% load editing %}
{% load crispy_forms_tags %}

{% block title %}
{{ changeset }}
{% endblock %}

{% block css_raw %}
  {% comment %} this css doesn't like compressing {% endcomment %}
  {% if revision.source_name == 'issue' %}
<link rel="stylesheet" type="text/css"
      href="{% static "jquery/css/msdropdown/dd.css" %}"/>
  {% endif %}
<script type="text/javascript" src="{% static "js/htmx.min.js" %}"></script>
{% endblock %}

{% block view_body %}
  {% include "oi/bits/jquery.html" %}
  {{ credits_formset.media }}
  {{ form.media }}

<h1>
  {{ changeset|header_link }}
</h1>

<div class="edit">
  <form action="{% url "process_revision" model_name=revision.source_name id=revision.id %}" method="POST">
  {% csrf_token %}
    <table class="editing">
  {% if revision.source_name == 'story' or revision.source_name == 'issue' %}
    {% crispy form %}
  {% else %}
    {{ form.as_table }}
  {% endif %}
    </table>
  {% with changeset.comments as comments %}
    {% include 'oi/bits/comments.html' %}
  {% endwith %}

    <btn class="btn-blue-editing inline"><input type="submit" name="save" value="Save And Continue Editing"></btn>
    <btn class="btn-blue-editing inline"><input type="submit" name="save_return" value="Save And Return To Changeset"></btn>
    <btn class="btn-blue-editing inline"><input type="submit" name="cancel_return"
         value="Return To Changeset Without Saving"></btn>
  {% if revision.source_name == 'story' and revision.old_credits %}
    <btn class="btn-blue-editing inline"><input type="submit" name="save_migrate" value="Save And Migrate Credits"></btn>
  {% endif %}
  </form>
</div>
{% endblock %}

{% block footer %}
  {% if revision.source_name in 'issue story' %}
    {% include 'oi/bits/revision_form_utils.html' %}
  {% endif %}
  {% if revision.source_name in 'story' %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('input[name="genre"]');
        const selectedDisplay = document.getElementById('selected-genres');

        function updateSelectedGenres() {
            const selected = Array.from(checkboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);

            if (selected.length) {
                selectedDisplay.innerHTML = selected.join('; ');
                selectedDisplay.style.display = 'block';
            } else {
                selectedDisplay.style.display = 'none';
            }
        }

        // Initial display
        updateSelectedGenres();

        // Add event listeners to all checkboxes
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedGenres);
        });
    });
    </script>
  {% endif %}
{% endblock %}

