{% load compare %}
{% load url from future %}

<form action="{% url 'process' id=changeset.id %}" method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <table class="editing" style="padding-top: 10px;">
        <input type="hidden" name="total_names" value="{{ other_name_details|length }}" id="total_names">

        <div class="gcd-official-name-div">
            <div class="name-details" style="padding-left: 43px;display: inline;">
                <label>Gcd Official Name:</label>
                <input type="text" id="gcd_official_name" name="gcd_official_name"
                       value="{{ official_name_details.name }}" required> &nbsp;
                <label>Type:</label>
                <select name="gcd_official_type" id="gcd_official_type" style="width: 125px;">
                    {% for name_type in name_types %}
                        {% if name_type.type == settings.GCD_OFFICIAL_NAME_FIELDNAME %}
                            <option value={{ name_type.id }}>{{ name_type.type }}</option>{% endif %}
                    {% endfor %}
                </select> &nbsp;

                <label>Source:</label>
                <select multiple style="vertical-align: middle;" name="gcd_official_sources"
                        id="gcd_official_sources">
                    {% for name_source in name_sources %}
                        <option {% if name_source.type|is_in:official_name_details.sources %} selected {% endif %}
                                                                                              value={{ name_source.id }}>{{ name_source.type }}</option>
                    {% endfor %}
                </select>&nbsp;
                <input type="button" id="add_name_divison_id" class="add_name_class" value="Add New"
                       name="add_name_divison">
                <br><br>
            </div>
        </div>

        <div class="name-div">
            {% for other_name_detail in other_name_details %}
                <div class="name-details{{ forloop.counter }}" style="padding-left: 113px;display: inline;">
                    <label>Name:</label>
                    <input type="text" id="name{{ forloop.counter }}" name="name{{ forloop.counter }}"
                           value="{{ other_name_detail.name }}" required> &nbsp;
                    <label>Type:</label>
                    <select name="type{{ forloop.counter }}" id="type{{ forloop.counter }}">
                        {% for name_type in name_types %}
                            {% if not name_type.type == settings.GCD_OFFICIAL_NAME_FIELDNAME %}
                                <option {% if name_type.type == other_name_detail.type %} selected {% endif %}
                                                                                          value={{ name_type.id }}>{{ name_type.type }}</option>
                            {% endif %}
                        {% endfor %}
                    </select> &nbsp;

                    <label>Source:</label>
                    <select multiple style="vertical-align: middle;" name="sources{{ forloop.counter }}"
                            id="sources{{ forloop.counter }}">
                        {% for name_source in name_sources %}
                            <option {% if name_source.type|is_in:other_name_detail.sources %} selected {% endif %}
                                                                                              value={{ name_source.id }}>{{ name_source.type }}</option>
                        {% endfor %}
                    </select>&nbsp;
                    <input type="button" id="add_name_divison_id" class="add_name_class" value="Add New"
                           name="add_name_divison">
                    <input type="button" id="remove_name_button" value="Remove" name="remove_this_name">`
                    <br><br>
                </div>
            {% endfor %}
        </div>

        {{ form.as_table }}

    </table>
    {% if changeset.comments.count > 1 %} {% comment %} change was sent back {% endcomment %}
        <p>
            <a href="{% url 'compare' id=changeset.id %}">Compare changes</a>
        </p>
    {% endif %}
    {% with changeset.comments as comments %}
        {% include 'oi/bits/comments.html' %}
    {% endwith %}
    {% ifequal revision.source_label "story" %}
        <input type="submit" name="save" value="Save and continue editing"></input>
        <input type="submit" name="save_return" value="Save and return to issue"></input>
        <input type="submit" name="cancel_return"
               value="Return to issue without saving"></input>
    {% else %}
        {% ifequal revision.source_label "issue" %}
            <input type="submit" name="save" value="Save and continue editing"></input>
        {% endifequal %}
        <input type="submit" name="submit" value="Submit changes for approval"></input>
        {% if changeset.approver %}
            <input type="submit" name="discuss" value="Discuss">
        {% endif %}
        <input type="button" id="confirm-discard" name="discard" value="Discard all changes"></input>
    {% endifequal %}
</form>


<script src="{{ MEDIA_URL }}jquery/js/jquery.min.js"></script>

<script type="text/javascript">
    $(document).ready(function () {
        var name_type_dropdown = '';
        {% for name_type in name_types %}
            {% if not name_type.type == settings.GCD_OFFICIAL_NAME_FIELDNAME %}
                name_type_dropdown = name_type_dropdown + '<option value="{{ name_type.id }}">{{ name_type.type }}</option>';
            {% endif %}
        {% endfor %}
        var name_sources_dropdown = '';
        {% for name_source in name_sources %}
            name_sources_dropdown = name_sources_dropdown + '<option value="{{ name_source.id }}">{{ name_source.type }}</option>';
        {% endfor %}

        $(document).on("click", ".add_name_class", function () {
            var total_names = parseInt($('#total_names').val());
            var next_index = total_names + 1;
            $('.name-div').append(
                    '<div class="name-details" style="padding-left: 110px;display: inline;">' +
                    ' <label>Name:</label>' +
                    '<input type="text" id="name' + next_index + '" name="name' + next_index + '" required> &nbsp;&nbsp;' +
                    '<label>Type:</label>' +
                    '<select name="type' + next_index + '" id="type' + next_index + '">'
                    + name_type_dropdown +
                    '</select> &nbsp;&nbsp;&nbsp;' +
                    '<label>Sources:</label>' +
                    '<select multiple name="sources' + next_index + '" id="sources' + next_index + '" style="vertical-align: middle;">'
                    + name_sources_dropdown +
                    '</select> &nbsp;' +
                    '<input type="button" id="add_name_divison_id" class="add_name_class" value="Add New" name="add_new_name">&nbsp;' +
                    '<input type="button" id="remove_name_button" value="Remove" name="remove_this_name">`' +
                    '<br><br>' +
                    '</div>');

            $('#total_names').val(next_index);
        });
        $(document).on("click", '#remove_name_button', function () {
            $(this).closest('div').remove();
        });

        $('#confirm-discard').click(function () {
            if ($('#id_comments').val() == "") {
                var is_comment = 0;
            } else {
                var is_comment = 1;
            }
            window.location.assign("{% url 'confirm_discard' changeset.id 0 %}".replace(0, is_comment));

        });
    });
</script>

