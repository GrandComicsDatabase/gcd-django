{% extends "gcd/tw_base_view.html" %}
{% load static %}
{% load credits %}
{% load display %}
{% load i18n %}

{% block title %}
  GCD :: {{ heading }}
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/output.css' %}" type="text/css">
{% endblock %}
{% block css_raw %}
<script type="text/javascript" src="{% static "js/htmx.min.js" %}"></script>
{% endblock %}

{% block view_body %}
<nav class="flex items-center justify-between flex-wrap bg-blue-100 px-1 lg:px-3">
  <div class="flex-1 font-bold text-lg">
  {{ page.start_index }} to {{ page.end_index }} of {{ page.paginator.count }} result{{ page.paginator.count|pluralize:'s' }} matching your search for '{{ request.GET.q }}'
  </div>
  {% with query_string=query|add:facet_page|add:sort %}
    {% include "gcd/bits/tw_pagination_bar.html" %}
  {% endwith %}
</nav>

  {% if suggestion %}
<p>Did you mean <a href="?q={{ suggestion }}">{{ suggestion }}</a> ?</p>
  {% endif %}
  {% if query and paginator.count > 0 %}
<h1 class="px-2">Search Results:</h1>
<div class="px-2">
  {% if facets.fields.facet_model_name %}
  <ul class="px-6 list-disc columns-2 sm:columns-3">
    {% for model in facets.fields.facet_model_name %}
    <li><a href="?{{ query }}{{ facet_page }}{% if not is_model_selected %}&amp;selected_facets=facet_model_name_exact:{{ model.0|urlencode }}{% endif %}">{{ model.0 }}</a> ({{ model.1 }})</li>
    {% endfor %}
  </ul>
  {% endif %}

  {% if paginator.count > 100 %}
  <div class='max-sm:hidden'>
    Too many results? Try adding further terms to limit the matches,
    e.g. publication year or publisher. Or put search terms in ""-quotes
    for exact matches, which also works for (exact) series name and
    issue number.
  </div>
  {% endif %}
</div>

<div class="flex">
  <div class="px-2 flex flex-col w-48 max-sm:hidden">
    <details {% if is_country_selected %} open="open" {% endif %} class="mb-2">
      <summary class="bg-blue-100">Country ({{ facets.fields.country|length }})</summary>
      <table>
  {% for country in facets.fields.country %}
        <tr class="hover:bg-blue-100">
          <td><a href="?{{ query }}{{ facet_page }}{% if not is_country_selected %}&amp;selected_facets=country_exact:{{ country.0|urlencode }}{% endif %}">{{ country.0|get_country_flag_by_name }} ({{ country.1}})</a>
          </td>
        </tr>
  {% endfor %}
      </table>
    </details>

    <details {% if is_language_selected %} open="open" {% endif %} class="mb-2">
      <summary class="bg-blue-100">Language ({{ facets.fields.language|length }}) </summary>
        <table class="facet_listing">
      {% for language in facets.fields.language %}
            <tr class="hover:bg-blue-100">
          <td><a href="?{{ query }}{{ facet_page }}{% if not is_language_selected %}&amp;selected_facets=language_exact:{{ language.0|urlencode }}{% endif %}">{{ language.0|get_native_language_name }} ({{ language.1}})</a>
          </td></tr>
      {% endfor %}
        </table>
      </details>

       <details {% if is_publisher_selected %} open="open" {% endif %} class="mb-2">
        <summary class="bg-blue-100">Publisher ({{ facets.fields.publisher|length }})</summary>
        <table>
      {% for publisher in facets.fields.publisher %}
            <tr class="hover:bg-blue-100">
          <td><a href="?{{ query }}{{ facet_page }}{% if not is_publisher_selected %}&amp;selected_facets=publisher_exact:{{ publisher.0|urlencode }}{% endif %}">{{ publisher.0 }} ({{ publisher.1}})</a>
          </td></tr>
      {% endfor %}
        </table>
      </details>

      <details {% if is_date_selected %} open="open" {% endif %} class="mb-2">
        <summary class="bg-blue-100">Year</summary>
        <table>
      {% for year in facets.dates.date %}
        {% if year.1 %}
            <tr class="hover:bg-blue-100">
          <td><a href="?{{ query }}{{ facet_page }}{% if not is_date_selected or forloop.counter > 1 %}&amp;date_facet={{ year.0|date:'Y-m-d H:i:s' }}{% endif %}">{{ year.0|date:"Y" }} ({{ year.1 }})</a>
          </td></tr>
	{% endif %}
      {% endfor %}
        </table>
      </details>

      <details {% if is_type_selected %} open="open" {% endif %} class="mb-2">
        <summary class="bg-blue-100">Sequence ({{ facets.fields.type|length }})</summary>
        <table>
      {% for type in facets.fields.type %}
            <tr class="hover:bg-blue-100">
          <td><a href="?{{ query }}{{ facet_page }}{% if not is_type_selected or forloop.counter > 1 %}&amp;selected_facets=type_exact:{{ type.0|urlencode }}{% endif %}">{{ type.0 }} ({{ type.1}})</a>
          </td></tr>
      {% endfor %}
        </table>
      </details>

      <details {% if is_feature_selected %} open="open" {% endif %} class="mb-2">
        <summary class="bg-blue-100">Feature ({{ facets.fields.feature|length }})</summary>
        <table>
      {% for feature in facets.fields.feature %}
            <tr class="hover:bg-blue-100">
          <td><a href="?{{ query }}{{ facet_page }}{% if not is_feature_selected or forloop.counter > 1 %}&amp;selected_facets=feature_exact:{{ feature.0|urlencode }}{% endif %}">{{ feature.0 }} ({{ feature.1}})</a>
          </td></tr>
      {% endfor %}
        </table>
      </details>
      </div>
      <div class="flex-1 ">
      <div class="left">
  {% if select_key and multiple_selects %}
  <form action="{% url "process_multiple_selects" select_key=select_key %}" method="POST">
    {% csrf_token %}
    <input type="submit" name="search_select" value="Submit">
    <div style="clear: both;"></div>
  {% endif %}
        <table class="border">
          <thead class="bg-blue-100">
          <tr>
      {% if select_key %}
            <th> Selection </th>
      {% endif %}
            <th class="min-w-24">Type</th>
            <th>Name</th>
          </tr>
          </thead>
          <tbody>
        {% for result in page.object_list %}
            <tr class="hover:bg-blue-50 sm:table-row border-y-2">
            {% if select_key %}
              <td>
              {% if result.model_name in allowed_selects %}
                {% if multiple_selects %}
                <input type="checkbox" name="object_choice" value="{{ result.model_name }}_{{ result.object.id }}">
                {% else %}
                <form action="{% url "select_object" select_key=select_key %}" method="POST">
                  {% csrf_token %}
                <input type="submit" name="search_select" value="Select this {{ result.model_name }}">
                <input type="hidden" name="object_choice" value="{{ result.model_name }}_{{ result.object.id }}">
                </form>
                {% endif %}
              {% endif %}
              </td>
            {% endif %}
            {% if result.model_name == 'series' %}
                <td class="pe-2">[SERIES]</td>
                <td><img {{ result.object.country|show_country_info }}  class="inline"> <a href="{{ result.object.get_absolute_url }}">{{ result.object.search_result_name }}</a></td>
            {% endif %}
            {% if result.model_name == 'issue' %}
                <td class="pe-2"><a hx-get="{% url "show_issue_modal" issue_id=result.object.id %}" hx-target="body" hx-swap="beforeend" style="cursor: pointer; color: #00e;" title="preview"><img class="inline" src="{% static "img/gcd/icons/"|add:ICON_SET_SYMBOLIC|add:"/preview-search.svg" %}" title="preview"></img> [ISSUE]</a></td>
                <td><img {{ result.object.series.country|show_country_info }}  class="inline"> <a href="{{ result.object.get_absolute_url }}"> {{ result.object.full_name }}</a>
                {{ result.object.publication_date|str_encl:'(' }}</td>
            {% endif %}
            {% if result.model_name == 'story' %}
                <td class="pe-2"><a hx-get="{% url "show_story_modal" story_id=result.object.id %}" hx-target="body" hx-swap="beforeend" style="cursor: pointer; color: #00e;" title="preview"><img class="inline" src="{% static "img/gcd/icons/"|add:ICON_SET_SYMBOLIC|add:"/preview-search.svg" %}" title="preview"></img> [STORY]</a></td>
                <td><a href="{{ result.object.get_absolute_url }}">{{ result.object|show_title:1 }}</a>
              {% if result.object.has_feature %} / {{ result.object.show_feature }}{% endif %} / {{ result.object.type }}
              {% if result.object.page_count %} / {{ result.object|show_page_count:1 }}{% endif %}
              (from
                <img {{ result.object.issue.series.country|show_country_info }}  class="inline">
                <a href="{{ result.object.issue.get_absolute_url }}">
              {{ result.object.issue.full_name }}</a> {{ result.object.issue.publication_date|str_encl:'(' }})</td>
            {% endif %}
            {% if result.model_name == 'feature' %}
                <td class="pe-2">[FEATURE]</td>
                <td><a href="{{ result.object.get_absolute_url }}">{{ result.object }}</a></td>
            {% endif %}
            {% if result.model_name == 'universe' %}
                <td class="pe-2">[UNIVERSE]</td>
                <td><a href="{{ result.object.get_absolute_url }}">{{ result.object }}</a></td>
            {% endif %}
            {% if result.model_name == 'character' %}
                <td class="pe-2">[CHARACTER]</td>
                <td><a href="{{ result.object.get_absolute_url }}">{{ result.object }}</a></td>
            {% endif %}
            {% if result.model_name == 'group' %}
                <td class="pe-2">[GROUP]</td>
                <td><a href="{{ result.object.get_absolute_url }}">{{ result.object }}</a></td>
            {% endif %}
            {% if result.model_name == 'publisher' %}
                <td class="pe-2">[PUBLISHER]</td>
                <td><img {{ result.object.country|show_country_info }}  class="inline"> <a href="{{ result.object.get_absolute_url }}">{{ result.object.name }}</a></td>
            {% endif %}
            {% if result.model_name == 'indiciapublisher' %}
                <td class="pe-2">[INDICIA PUBLISHER]</td>
                <td><img {{ result.object.country|show_country_info }}  class="inline"> <a href="{{ result.object.parent.get_absolute_url }}">{{ result.object.parent.name }}</a>
              :
                <a href="{{ result.object.get_absolute_url }}">{{ result.object.name }}</a></td>
            {% endif %}
            {% if result.model_name == 'brand' %}
                <td class="pe-2">[BRAND EMBLEM]</td>
                <td><a href="{{ result.object.get_absolute_url }}">{{ result.object.name }}</a></td>
            {% endif %}
            {% if result.model_name == 'brandgroup' %}
                <td class="pe-2">[BRAND GROUP]</td>
                <td><img {{ result.object.parent.country|show_country_info }}  class="inline"> <a href="{{ result.object.parent.get_absolute_url }}">{{ result.object.parent.name }}</a>
                :
                  <a href="{{ result.object.get_absolute_url }}">{{ result.object.name }}</a></td>
            {% endif %}
            {% if result.model_name == 'printer' %}
                <td class="pe-2">[PRINTER]</td>
                <td><img {{ result.object.country|show_country_info }}  class="inline"> <a href="{{ result.object.get_absolute_url }}">{{ result.object.name }}</a></td>
            {% endif %}
            {% if result.model_name == 'award' %}
                <td class="pe-2">[AWARD]</td>
                <td><a href="{{ result.object.get_absolute_url }}">{{ result.object }}</a></td>
            {% endif %}

            {% if result.model_name == 'creator' %}
                <td class="pe-2">[CREATOR]</td>
                <td><img {{ result.object.birth_country|show_country_info }}  class="inline"> <a href="{{ result.object.get_absolute_url }}">{{ result.object.search_result_name }}</a></td>
            {% endif %}
            {% if result.model_name == 'creatormembership' %}
                <td class="pe-2">[CREATOR MEMBERSHIP]</td>
                <td><a href="{{ result.object.get_absolute_url }}">{{ result.object.organization_name }}</a></td>
            {% endif %}
            {% if result.model_name == 'creatorartinfluence' %}
                <td class="pe-2">[CREATOR ART INFLUENCE]</td>
                <td><a href="{{ result.object.get_absolute_url }}">{{ result.object }}</a></td>
            {% endif %}
            {% if result.model_name == 'receivedaward' %}
                <td class="pe-2">[RECEIVED AWARD]</td>
                <td><a href="{{ result.object.get_absolute_url }}">{{ result.object.award }} - {{ result.object.display_name }}: {{ result.object.recipient }}</a></td>
            {% endif %}
            {% if result.model_name == 'creatornoncomicwork' %}
                <td class="pe-2">[CREATOR NONCOMICWORK]</td>
                <td><a href="{{ result.object.get_absolute_url }}">{{ result.object.publication_title }}</a></td>
            {% endif %}
            </tr>
        {% endfor %}
        </tbody>
        </table>
      </div>
      </div> <!-- #RightSearchColumn -->
      </div>
      {% if select_key and multiple_selects %}
      <div style="clear: both;"></div>
        <input type="submit" name="search_select" value="Submit">
        </form>
      {% endif %}
      <div style="clear: both;"></div>
      {% if sort %}
        {% if 'country' in sort %}
          <p>Sort is per <a href="http://docs.comics.org/wiki/Country_and_Currency_and_Language_Codes">country code</a>, within a country by relevance.</p>
        {% endif %}
        {% if 'year' in sort or 'chrono' in sort %}
          <p>Objects with no date information are listed at the end.</p>
        {% endif %}
      {% endif %}

    {% else %}
      {% if query %}
      <div class="px-2">No results.</div>
      {% endif %}
    {% endif %}
      <div class="px-2">Please enter the search word(s) in the box. The search is looking for exact matches for each word.
      <p>You can use four ways to further modify a search:
        <ul class="px-6 list-disc">
          <li>""-quotes search for phrases, e.g. "Batman and Superman" or "Asterix 1"
          <li>'-' in front of a word or phrase filters out matching results, e.g. Spider-Man Ditko -Lee
          <li>* acts as a wild card, e.g. Spir* finds Spirit and Spirou
          <li>using OR in a search finds matches for the terms before the OR or the <b>one</b> term/phrase directly after the OR, e.g. Grant Morrison OR "Warren Ellis", which is different to Grant Morrison OR Warren Ellis.
        </ul>
      Special characters, e.g. ,;/, are ignored.
      </div>
<nav class="flex items-center justify-between flex-wrap bg-blue-100 px-1 lg:px-3">
    <div></div>
  {% with query_string=query|add:facet_page|add:sort %}
    {% include "gcd/bits/tw_pagination_bar.html" %}
  {% endwith %}
</nav>
{% include 'oi/bits/jquery.html' with details=True %}
{% endblock %}
